{% extends "layout.html" %}

{% block content %}
<div class="container my-5">
  <h1 class="text-left mb-4">Course List ğŸ“š</h1>

  {% if error %}
    {% if "no matches" in error|lower %}
      <div class="alert alert-warning mt-2" role="alert">
        âš ï¸ {{ error }}
      </div>
    {% else %}
      <div class="alert alert-danger" role="alert">
        âŒ {{ error }}
      </div>
    {% endif %}
  {% endif %}

  <form action="{{ url_for('course_list') }}" class="mb-4" method="POST">
    <div class="row g-3">

      <!-- Gender Filter -->
      <div class="col-md-6 col-lg-4">
        <div class="input-group">
          <label class="input-group-text" for="gender">Gender ğŸ‘¥</label>
          <select class="form-select" id="gender" name="gender">
            <option value="" {% if not form_data.get('gender') %}selected{% endif %}>Select gender</option>
            <option value="female" {% if form_data.get('gender') == 'female' %}selected{% endif %}>Female</option>
            <option value="male" {% if form_data.get('gender') == 'male' %}selected{% endif %}>Male</option>
            <option value="other" {% if form_data.get('gender') == 'other' %}selected{% endif %}>Other</option>
          </select>
        </div>
      </div>

      <!-- Target Group Filter -->
      <div class="col-md-6 col-lg-4">
        <div class="input-group w-100">
          <label class="input-group-text">I identify with... ğŸ¯</label>
          <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="targetGroupDropdown"
              data-bs-toggle="dropdown" aria-expanded="false">
              Select one or more
            </button>
            <ul class="dropdown-menu p-3" aria-labelledby="targetGroupDropdown"
              style="max-height: 300px; overflow-y: auto;">
              <li>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="target_group" value="Not applicable"
                    id="target_group_na"
                    {% if 'Not applicable' in form_data.getlist('target_group') or not form_data.getlist('target_group') %}checked{% endif %}>
                  <label class="form-check-label" for="target_group_na">Not applicable</label>
                </div>
              </li>

              {% set target_groups = [
                "People with a migration background",
                "Illiterate people",
                "Women",
                "People with disabilities",
                "Older adults / older people",
                "Other target groups",
                "Children",
                "Adolescents / young people"
              ] %}

              {% for group in target_groups %}
              <li>
                <div class="form-check">
                  <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group"
                    value="{{ group }}" id="target_group_{{ loop.index }}"
                    {% if group in form_data.getlist('target_group') %}checked{% endif %}>
                  <label class="form-check-label" for="target_group_{{ loop.index }}">{{ group }}</label>
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>

      <!-- Budget input -->
      <div class="col-md-6 col-lg-4">
        <div class="input-group">
          <label class="input-group-text" for="budget">Budget ğŸ’°</label>
          <input type="number" class="form-control" id="budget" name="budget" placeholder="Enter Budget"
            value="{{ form_data.get('budget', '') }}">
          <span class="input-group-text">â‚¬</span>
        </div>
      </div>

      <!-- Search Field -->
      <div class="col-12">
        <div class="input-group">
          <input type="text" name="search" class="form-control" placeholder="Search for courses... ğŸ”"
            value="{{ form_data.get('search', '') }}">
          <button class="btn btn-primary" type="submit">Search ğŸ”</button>
        </div>
      </div>

      <!-- Selected Filters Display -->
      <div class="row g-2 mt-2">
        {% if form_data.getlist('target_group') %}
        <div class="col-auto">
          <span class="badge bg-light text-dark">ğŸ¯ Target Groups:
            {{ form_data.getlist('target_group') | join(', ') }}</span>
        </div>
        {% endif %}
        {% if form_data.get('gender') %}
        <div class="col-auto">
          <span class="badge bg-light text-dark">ğŸ‘¥ Gender: {{ form_data.get('gender') }}</span>
        </div>
        {% endif %}
      </div>

      <div class="mb-3 mt-3">
        <h5>âœ¨ {{ courses|length }} courses found</h5>
      </div>
    </div>
  </form>

  <!-- Courses Table -->
  <table class="table table-bordered table-hover mt-4">
    <thead class="table-light">
      <tr>
        <th>Course Title ğŸ“</th>
        <th>District ğŸ˜ï¸</th>
        <th>Location ğŸ“</th>
        <th>Price (â‚¬) ğŸ’¶</th>
        <th>Course Duration â°</th>
        <th>Session Times ğŸ•’</th>
        <th>No. of Sessions #ï¸âƒ£</th>
        <th>Link ğŸ”—</th>
        <th>Sponsored â­</th>
      </tr>
    </thead>
    <tbody>
      {% for course in courses %}
      <tr>
        <td>{{ course['course_name_translated'] }}</td>
        <td>{{ course['district'] }}</td>
        <td>
          {% if course['locations_address'] and course['locations_address'][0] %}
          {{ course['locations_address'][0]['strasse'] }},
          {{ course['locations_address'][0]['plz'] }} {{ course['locations_address'][0]['ort'] }}
          {% else %}
          Not Available
          {% endif %}
        </td>
        <td>{{ course['price_amount'] | default('N/A') }}</td>
        <td>{{ course['start_date'] }} to {{ course['end_date'] }}</td>
        <td>
          {% if course['locations_appointments'] and course['locations_appointments'][0] %}
          {{ course['locations_appointments'][0]['beginn_uhrzeit'] }}
          to {{ course['locations_appointments'][0]['ende_uhrzeit'] }}
          {% else %}
          Not Available
          {% endif %}
        </td>
        <td>{{ course['number_of_sessions'] }}</td>
        <td>
          {% if course['website_uri'] %}
          <a href="{{ course['website_uri'] }}" target="_blank">Book</a>
          {% else %}
          Not Available
          {% endif %}
        </td>
        <td>{{ 'Sponsored' if course['sponsored'] == 1 else '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- JS Validation (target groups only) -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');

    form.addEventListener('submit', function (event) {
      let hasErrors = false;

      const targetGroups = document.querySelectorAll('input[name="target_group"]:checked');
      if (targetGroups.length === 0) {
        hasErrors = true;
        const existingError = document.getElementById('target-group-error');
        if (existingError) existingError.remove();

        const errorDiv = document.createElement('div');
        errorDiv.id = 'target-group-error';
        errorDiv.className = 'alert alert-danger mt-2';
        errorDiv.innerText = 'Please select at least one target group or "Not applicable".';

        const targetGroupContainer = document.querySelector('.dropdown').parentElement;
        targetGroupContainer.parentNode.insertBefore(errorDiv, targetGroupContainer.nextSibling);
      }

      if (hasErrors) event.preventDefault();
    });
  });
</script>
{% endblock %}
