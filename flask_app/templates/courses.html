{% extends "layout.html" %}

{% block content %}
<div class="container my-5">
    <h1 class="text-left mb-4">Course List</h1>

     <!-- Search Bar --> 
     <form method="POST" action="{{ url_for('course_list') }}" class="mb-4">
        <div class="row g-3">
        
 


            <!-- Gender Filter -->
            <div class="col-md-6 col-lg-4">
                <div class="input-group">
                    <label class="input-group-text" for="gender">Gender</label>
                    <select class="form-select" id="gender" name="gender">
                        <option value="" {% if not request.form.get('gender') %}selected{% endif %}>All</option>
                        <option value="female" {% if request.form.get('gender') == 'female' %}selected{% endif %}>Female</option>
                        <option value="male" {% if request.form.get('gender') == 'male' %}selected{% endif %}>Male</option>
                        <option value="other" {% if request.form.get('gender') == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
            </div>

            <!-- Target Group Filter -->
            <div class="col-md-6 col-lg-4">
                <div class="input-group w-100" style="width: 100%;">
                    <label class="input-group-text">I identify with... </label>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="targetGroupDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                             Select one or more
                        </button>
                        <ul class="dropdown-menu p-3" aria-labelledby="targetGroupDropdown" style="max-height: 300px; overflow-y: auto;">
                            <!-- Select All Option -->
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select_all_target_groups" onclick="toggleAllTargetGroups(this)">
                                    <label class="form-check-label" for="select_all_target_groups">Select All</label>
                                </div>
                            </li>
                            <!-- Individual Target Groups -->
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="People with a migration background" id="target_group_migration" {% if 'People with a migration background' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_migration">People with a migration background</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="Illiterate people" id="target_group_illiterate" {% if 'Illiterate people' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_illiterate">Illiterate people</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="Women" id="target_group_women" {% if 'Women' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_women">Women</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="People with disabilities" id="target_group_disabilities" {% if 'People with disabilities' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_disabilities">People with disabilities</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="Older adults / older people" id="target_group_older_adults" {% if 'Older adults / older people' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_older_adults">Older adults / older people</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="Other target groups" id="target_group_other" {% if 'Other target groups' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_other">Other target groups</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="Children" id="target_group_children" {% if 'Children' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_children">Children</label>
                                </div>
                            </li>
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input target-group-checkbox" type="checkbox" name="target_group" value="Adolescents / young people" id="target_group_adolescents" {% if 'Adolescents / young people' in request.form.getlist('target_group') %}checked{% endif %}>
                                    <label class="form-check-label" for="target_group_adolescents">Adolescents / young people</label>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Budget imput -->
            <div class="col-md-6 col-lg-4">
                <div class="input-group">
                  <label class="input-group-text" for="budget">Budget</label>
                  <input type="number" class="form-control" id="budget" name="budget" placeholder="Enter Budget" value="{{ request.form.get('budget', '') }}">
                  <span class="input-group-text">€</span>
                </div>
              </div>
               <!-- Search Field -->
               <div class="col-12">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" placeholder="Search for courses..." value="{{ request.form.get('search', '') }}">
                    <button class="btn btn-primary" type="submit">Search</button>
                </div>
            </div>          

    <!-- Selected Filters Display -->
    <div class="row g-2">
        <!-- Target Group Filter -->
        {% if request.form.getlist('target_group') %}
            <div class="col-auto">
                <span class="badge bg-light text-dark">Target Groups: {{ request.form.getlist('target_group')|join(', ') }}</span>
            </div>
        {% endif %}

        <!-- Gender Filter -->
        {% if request.form.get('gender') %}
            <div class="col-auto">
                <span class="badge bg-light text-dark">Gender: {{ request.form.get('gender') }}</span>
            </div>
        {% endif %}

          <!-- Results count -->
     <div class="mb-3">
        <h5>{{ courses|length }} courses found</h5>
    </div>
  </div>
</form>


    <!-- Courses Table -->
  <table class="table table-bordered table-hover mt-4">
    <thead class="table-light">
      <tr>
        <th>Course Title</th>
        <th>District</th>
        <th>Location</th>
        <th>Price (€)</th>
        <th>Course Duration</th>
        <th>Session Times</th>
        <th>No. of Sessions</th>
        <th>Link</th>
        <th>Sponsored</th>
      </tr>
    </thead>
    <tbody>
      {% for course in courses %}
      <tr>
        <td>{{ course['course_name_translated'] }}</td>
        <td>{{ course['district'] }}</td>
        <td>
          {% if course['locations_address'] and course['locations_address'][0] %}
            {{ course['locations_address'][0]['strasse'] }},
            {{ course['locations_address'][0]['plz'] }} {{ course['locations_address'][0]['ort'] }}
          {% else %}
            Not Available
          {% endif %}
        </td>
        <td>{{ course['price_amount'] | default('N/A') }}</td>
        <td>{{ course['start_date'] }} to {{ course['end_date'] }}</td>
        <td>
          {% if course['locations_appointments'] and course['locations_appointments'][0] %}
            {{ course['locations_appointments'][0]['beginn_uhrzeit'] }}
            to {{ course['locations_appointments'][0]['ende_uhrzeit'] }}
          {% else %}
            Not Available
          {% endif %}
        </td>
        <td>{{ course['number_of_sessions'] }}</td>
        <td>
          {% if course['website_uri'] %}
            <a href="{{ course['website_uri'] }}" target="_blank">Book</a>
          {% else %}
            Not Available
          {% endif %}
        </td>
        <td>{{ 'Sponsored' if course.sponsored == 1 else '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get the form element
    const form = document.querySelector('form');
    
    // Add submit event listener to the form
    form.addEventListener('submit', function(event) {
      let hasErrors = false;
      
      // Check if any target group checkboxes are checked
      const targetGroups = document.querySelectorAll('input[name="target_group"]:checked');
      
      // If no target groups are selected, prevent form submission and show an error
      if (targetGroups.length === 0) {
        hasErrors = true;
        
        // Remove any existing error message
        const existingError = document.getElementById('target-group-error');
        if (existingError) {
          existingError.remove();
        }
        
        // Create and show the error message
        const errorDiv = document.createElement('div');
        errorDiv.id = 'target-group-error';
        errorDiv.className = 'alert alert-danger mt-2';
        errorDiv.innerText = 'Please select at least one option';
        
        // Insert the error after the target group dropdown
        const targetGroupContainer = document.querySelector('.dropdown').parentElement;
        targetGroupContainer.parentNode.insertBefore(errorDiv, targetGroupContainer.nextSibling);
      }
      
      // Check if budget field is empty or invalid
      const budgetField = document.getElementById('budget');
      const budgetValue = budgetField.value.trim();
      
      if (budgetValue === '') {
        hasErrors = true;
        
        // Remove any existing error message
        const existingError = document.getElementById('budget-error');
        if (existingError) {
          existingError.remove();
        }
        
        // Create and show the error message
        const errorDiv = document.createElement('div');
        errorDiv.id = 'budget-error';
        errorDiv.className = 'alert alert-danger mt-2';
        errorDiv.innerText = 'Please enter a budget amount';
        
        // Insert the error after the budget input
        const budgetContainer = budgetField.closest('.input-group');
        budgetContainer.parentNode.insertBefore(errorDiv, budgetContainer.nextSibling);
      }
      
      // If there are any errors, prevent form submission
      if (hasErrors) {
        event.preventDefault();
      }
    });
  });
  </script>
{% endblock %}
